(function(p,g){function d(a,b){this.$ele=a;this.init();this.areas=b.initAreas;this.options=b;this.status=f.CREATE;this.dragging=!1;this.resizeDirection=null;this.dragAreaOffset={};this.draw()}console.log("jquery.areaSelect.js by Gongshw https://github.com/gongshw/jquery.areaSelect.js");var f={CREATE:"create",MOVE:"move",RESIZE:"resize",NEAR:"near"},n={NE:{name:"NE",x:1,y:-1,cursor:"nesw-resize"},NW:{name:"NW",x:-1,y:-1,cursor:"nwse-resize"},SE:{name:"SE",x:1,y:1,cursor:"nwse-resize"},SW:{name:"SW",
x:-1,y:1,cursor:"nesw-resize"}};d.prototype.get=function(){return this.areas};d.prototype.bindChangeEvent=function(a){this.$canvas.on("areasChange",a[0])};d.prototype.init=function(){var a=p("<canvas/>");a.attr("width",this.$ele.width()).attr("height",this.$ele.height()).offset(this.$ele.position()).css({position:"absolute",zIndex:1E6}).appendTo(this.$ele.parent());this.$canvas=a;this.g2d=a[0].getContext("2d");var b=this,c,g;a.mousemove(function(a){var c=k(a);a=l(a);if(b.dragging)b.onDragging(c,a);
else b.onMouseMoving(c,a)}).mousedown(function(a){c=k(a);g=l(a);b.onDragStart(k(a),l(a))}).mouseup(function(a){if(k(a)==c&&l(a)==g)b.onClick(k(a),l(a));b.onDragStop()}).dblclick(function(a){b.onDoubleClick(k(a),l(a))})};d.prototype.onDragStart=function(a,b){this.dragging=!0;switch(this.status){case f.RESIZE:!this.currentArea||r(this.currentArea,this.resizeDirection);break;case f.MOVE:this.dragAreaOffset={x:this.currentArea.x-a,y:this.currentArea.y-b};break;case f.CREATE:var c={x:a,y:b,width:0,height:0};
this.areas.push(c);this.currentArea=c;this.status=f.RESIZE}};d.prototype.onDragStop=function(){this.dragging=!1;switch(this.status){case f.RESIZE:this.currentArea!=g&&(0==this.currentArea.width&&0==this.currentArea.height?(this.deleteArea(this.currentArea),this.currentArea=g,this.status=f.CREATE):(r(this.currentArea,n.SE),this.triggerChange()));break;case f.MOVE:this.triggerChange()}};d.prototype.onMouseMoving=function(a,b){var c=this.getArea(a,b,this.options.padding),d=this.$canvas;if(c!=g){this.currentArea=
c;var h=!1,e=null,c=s(c),q;for(q in c){var t=b,m=c[q],k=this.options.padding;if(Math.pow(a-m.x,2)+Math.pow(t-m.y,2)<=Math.pow(k,2)){h=!0;e=n[q];break}}h?(d.css({cursor:e.cursor}),this.status=f.RESIZE,this.resizeDirection=e):this.getArea(a,b,-this.options.padding)!=g?(d.css({cursor:"move"}),this.status=f.MOVE):(d.css({cursor:"auto"}),this.status=f.NEAR)}else this.currentArea=g,d.css({cursor:"auto"}),this.status=f.CREATE;this.draw()};d.prototype.onDragging=function(a,b){var c=this.currentArea;switch(this.status){case f.RESIZE:c.width=
a-c.x;c.height=b-c.y;break;case f.MOVE:c.x=a+this.dragAreaOffset.x,c.y=b+this.dragAreaOffset.y}this.draw()};d.prototype.onDoubleClick=function(a,b){var c=this.getArea(a,b,this.options.padding);c!=g&&"doubleClick"==this.options.deleteMethod&&(this.deleteArea(c),this.draw())};d.prototype.onClick=function(a,b){var c=this.getArea(a,b,this.options.padding);c!=g&&"click"==this.options.deleteMethod&&(this.deleteArea(c),this.draw())};d.prototype.draw=function(){var a=this.g2d;a.clearRect(0,0,this.$canvas[0].width,
this.$canvas[0].height);a.strokeStyle=this.options.area.strokeStyle;a.lineWidth=this.options.area.lineWidth;for(var b in this.areas){var c=this.areas[b];this.g2d.strokeRect(c.x,c.y,c.width,c.height)}c=this.currentArea;a.fillStyle=this.options.point.fillStyle;if(c!=g)for(b in c=s(c),c){var d=c[b];a.beginPath();a.arc(d.x,d.y,this.options.point.size,0,2*Math.PI,!0);a.closePath();a.fill()}};d.prototype.deleteArea=function(a){var b=this.areas;0<=b.indexOf(a)&&(b.splice(b.indexOf(a),1),this.currentArea=
g,this.triggerChange(),this.status=f.CREATE)};d.prototype.getArea=function(a,b,c){c=c===g?0:c;for(var d in this.areas){var h=this.areas[d],e=Math.abs,f=h.x,k=h.x+h.width,m=h.y,l=h.y+h.height;if(0<=c&&e(f-a)+e(k-a)-e(h.width)<=2*c&&e(m-b)+e(l-b)-e(h.height)<=2*c||0>c&&0==e(f-a)+e(k-a)-e(h.width)&&0==e(m-b)+e(l-b)-e(h.height)&&e(e(f-a)-e(k-a))<=e(h.width)+2*c&&e(e(m-b)-e(l-b))<=e(h.height)+2*c)return h}return g};d.prototype.triggerChange=function(){this.$canvas.trigger("areasChange",{areas:this.areas})};
var s=function(a){var b={},c;for(c in n)b[c]={x:a.x+a.width*(n[c].x+1)/2,y:a.y+a.height*(n[c].y+1)/2};return b},r=function(a,b){if(a!=g&&b!=g){var c=a.x,d=a.x+a.width,f=a.y,e=a.y+a.height,k=Math.abs(a.width),l=Math.abs(a.height),m={1:Math.min,"-1":Math.max};a.x=m[b.x](c,d);a.y=m[b.y](f,e);a.width=b.x*k;a.height=b.y*l}},k=function(a){return a.offsetX?a.offsetX:a.originalEvent.layerX},l=function(a){return a.offsetY?a.offsetY:a.originalEvent.layerY};p.fn.areaSelect=function(a){var b,c={initAreas:[],
deleteMethod:"click",padding:3,area:{strokeStyle:"red",lineWidth:2},point:{size:3,fillStyle:"black"}};b=this.data("AreaSelect");if(b!=g||a!==g&&!p.isPlainObject(a))if(b===g)console.error("pls invoke areaSelect() on this element first!");else{if(b[a]!=g)return b[a](Array.prototype.slice.call(arguments,1));console.error("no function "+a)}else b=p.extend({},c,a),b=new d(this,b),this.data("AreaSelect",b)}})(jQuery);
